(function(m,A,j,R,$,p,o){"use strict";function _(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var O=_(A),P=_(j),F=_(R),f=_($);function G(e,i){let n=e.length;for(;n--;)if(i(e[n],n,e))return n;return-1}function w(e){return{discriminator:e.discriminator,username:e.username,avatar:e.avatar,id:e.id,bot:e.bot,public_flags:typeof e.publicFlags<"u"?e.publicFlags:e.public_flags}}function x(e){if(!e?.id)return e;const i={};return typeof e.rawTitle=="string"&&(i.title=e.rawTitle),typeof e.rawDescription=="string"&&(i.description=e.rawDescription),typeof e.referenceId<"u"&&(i.reference_id=e.referenceId),typeof e.color=="string"&&(i.color=ZeresPluginLibrary.ColorConverter.hex2int(e.color)),typeof e.type<"u"&&(i.type=e.type),typeof e.url<"u"&&(i.url=e.url),typeof e.provider=="object"&&(i.provider={name:e.provider.name,url:e.provider.url}),typeof e.footer=="object"&&(i.footer={text:e.footer.text,icon_url:e.footer.iconURL,proxy_icon_url:e.footer.iconProxyURL}),typeof e.author=="object"&&(i.author={name:e.author.name,url:e.author.url,icon_url:e.author.iconURL,proxy_icon_url:e.author.iconProxyURL}),typeof e.timestamp=="object"&&e.timestamp._isAMomentObject&&(i.timestamp=e.timestamp.milliseconds()),typeof e.thumbnail=="object"&&(typeof e.thumbnail.proxyURL=="string"||typeof e.thumbnail.url=="string"&&!e.thumbnail.url.endsWith("?format=jpeg"))&&(i.thumbnail={url:e.thumbnail.url,proxy_url:typeof e.thumbnail.proxyURL=="string"?e.thumbnail.proxyURL.split("?format")[0]:void 0,width:e.thumbnail.width,height:e.thumbnail.height}),typeof e.image=="object"&&(i.image={url:e.image.url,proxy_url:e.image.proxyURL,width:e.image.width,height:e.image.height}),typeof e.video=="object"&&(i.video={url:e.video.url,proxy_url:e.video.proxyURL,width:e.video.width,height:e.video.height}),Array.isArray(e.fields)&&e.fields.length&&(i.fields=e.fields.map(n=>({name:n.rawName,value:n.rawValue,inline:n.inline}))),i}function v(e){const i={mention_everyone:typeof e.mention_everyone!="boolean"?typeof e.mentionEveryone!="boolean"?!1:e.mentionEveryone:e.mention_everyone,edited_timestamp:e.edited_timestamp||e.editedTimestamp&&new Date(e.editedTimestamp).getTime()||null,attachments:e.attachments||[],channel_id:e.channel_id,reactions:(e.reactions||[]).map(n=>(!n.emoji.animated&&delete n.emoji.animated,!n.me&&delete n.me,n)),guild_id:e.guild_id||(o.ChannelStore.getChannel(e.channel_id)?o.ChannelStore.getChannel(e.channel_id).guild_id:void 0),content:e.content,type:e.type,embeds:e.embeds||[],author:w(e.author),mentions:(e.mentions||[]).map(n=>typeof n=="string"?o.UserStore.getUser(n)?w(o.UserStore.getUser(n)):n:w(n)),mention_roles:e.mention_roles||e.mentionRoles||[],id:e.id,flags:e.flags,timestamp:new Date(e.timestamp).getTime(),referenced_message:null};return i.type===19&&(i.message_reference=e.message_reference||e.messageReference,i.message_reference&&(e.referenced_message?i.referenced_message=v(e.referenced_message):o.MessageStore.getMessage(i.message_reference.channel_id,i.message_reference.message_id)&&(i.referenced_message=v(o.MessageStore.getMessage(i.message_reference.channel_id,i.message_reference.message_id))))),e.embeds=e.embeds.map(x),i}var k={load(){const e=[];let i=!1;async function n(){if(i)return;let t=e.shift();t&&(i=!0,await t(),i=!1,setTimeout(n,0))}function I(t){return new Promise(a=>{let r=v(t);e.push(async()=>{let s=await f.default.get(`DeletedMessages;Channel;${r.channel_id}`,{});s[r.id]={message:r,saved_at:Date.now()},await f.default.set(`DeletedMessages;Channel;${r.channel_id}`,s),a()}),n()})}function B(t){return new Promise(a=>{e.push(async()=>{let r=await f.default.get(`DeletedMessages;Channel;${t.channel_id}`,{});delete r[t.id],await f.default.set(`DeletedMessages;Channel;${t.channel_id}`,r),a(),o.FluxDispatcher.dispatch({type:"MESSAGE_DELETE",channelId:t.channel_id,id:t.id,__original__:!0})}),n()})}function H(t,a){return new Promise(r=>{e.push(async()=>{let s=await f.default.get(`DeletedMessages;Channel;${t.channel_id}`);s&&(s[t.id]&&await a(s[t.id]),await f.default.set(`DeletedMessages;Channel;${t.channel_id}`,s)),r()}),n()})}async function K(t,a,r,s){if(!t.length)return;const u=await f.default.get(`DeletedMessages;Channel;${a}`,{}),y=Object.keys(u),U=14200704e5,M=[],h=[];for(let l=0,d=t.length;l<d;l++){const{id:c}=t[l];M.push({id:c,time:c/4194304+U})}for(let l=0,d=y.length;l<d;l++){const c=y[l],D=u[c];!D||D.hidden||h.push({id:c,time:c/4194304+U})}if(h.sort((l,d)=>l.time-d.time),!h.length)return;const{time:Q}=M.at(-1),{time:V}=M.at(0),L=s?0:h.findIndex(l=>l.time>Q);if(L===-1)return;const T=r?h.length-1:G(h,l=>l.time<V);if(T===-1)return;const E=h.slice(L,T+1);E.push(...M),E.sort((l,d)=>d.time-l.time);for(let l=0,d=E.length;l<d;l++){const{id:c}=E[l];t.findIndex(D=>D?.id===c)===-1&&(t.splice(l,0,u[c]?.message),console.log(u[c]?.message))}}async function C(t){let[,,a,r]=t.id.split("-");if((await f.default.get(`DeletedMessages;Channel;${a}`))?.[r]){let u=F.default.react.getProps(t,y=>y?.message)?.message;return u&&(u.__deleted__=!0),t.style.backgroundColor="rgba(255,0,0,0.1)",()=>{t.style.backgroundColor=""}}else t.style.backgroundColor=""}function g(){document.querySelectorAll('[id^="chat-messages-"]').forEach(C)}function S(t){if(!t||(t.flags&64)===64)return!0;let a=o.UserStore.getUser(t.author.id);if(!a||a?.bot)return!0}m.subscriptions.push(O.default.patch('[id^="chat-messages-"]',C),p.contextMenus.patch("message",(t,a)=>{!a.message.__deleted__||t.props.children.push(p.contextMenus.build.item({type:"separator"}),p.contextMenus.build.item({label:m.i18n.format("DELETE_FROM_ME"),danger:!0,action(){B(a.message).then(g)}}),p.contextMenus.build.item({label:m.i18n.format("HIDE_FROM_ME"),action(){o.FluxDispatcher.dispatch({type:"MESSAGE_DELETE",channelId:a.message.channel_id,id:a.message.id,__original__:!0})}}))}),P.default.instead("dispatch",o.FluxDispatcher,async function(t,a){if(t[0].__original__)return a.call(this,...t);if(t[0].type==="MESSAGE_DELETE"){let r=o.MessageStore.getMessage(t[0].channelId,t[0].id);if(S(r))return a.call(this,...t);I(o.MessageStore.getMessage(t[0].channelId,t[0].id)).then(g);return}if(t[0].type==="MESSAGE_DELETE_BULK"){let r=[];t[0].ids.forEach(s=>{let u=o.MessageStore.getMessage(t[0].channelId,s);if(S(u))return r.push(s);I(u)}),r.length&&o.FluxDispatcher.dispatch({type:"MESSAGE_DELETE_BULK",ids:r,channelId:t[0].channelId,guildId:t[0].guildId,__original__:!0}),setTimeout(g,0);return}t[0].type==="LOAD_MESSAGES_SUCCESS"&&(await K(t[0].messages,t[0].channelId,!t[0].hasMoreAfter&&!t[0].isBefore,!t[0].hasMoreBefore&&!t[0].isAfter),setTimeout(g,50));try{if(t[0].type==="MESSAGE_UPDATE"){if(S(t[0].message))return a.call(this,...t);t[0].message.edited_timestamp||H(t[0].message,async r=>{r.message.embeds=t[0].message.embeds.map(x)})}}catch{}return a.call(this,...t)}))},unload(){}};return k})($acord.extension,$acord.dom,$acord.patcher,$acord.utils,$acord.storage.shared,$acord.ui,$acord.modules.common);
